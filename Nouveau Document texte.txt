<?php
session_start();
require_once '../db/config.php';

// ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
if (!isset($_SESSION['user'])) {
    header("Location: login.php");
    exit();
}

// ุฅุถุงูุฉ ููุนุฏ ุฌุฏูุฏ
if (isset($_POST['add_appointment'])) {
    $patient_name = $_POST['patient_name'];
    $doctor_name = $_POST['doctor_name'];
    $appointment_date = $_POST['appointment_date'];
    $appointment_time = $_POST['appointment_time'];
    $status = $_POST['status'];

    $sql = "INSERT INTO appointments (patient_name, doctor_name, appointment_date, appointment_time, status)
            VALUES ('$patient_name', '$doctor_name', '$appointment_date', '$appointment_time', '$status')";
    $conn->query($sql);
    $message = "ุชูุช ุฅุถุงูุฉ ุงูููุนุฏ ุจูุฌุงุญ!";
}

// ุชุญุฏูุซ ููุนุฏ
if (isset($_POST['update_appointment'])) {
    $id = $_POST['appointment_id'];
    $patient_name = $_POST['patient_name'];
    $doctor_name = $_POST['doctor_name'];
    $appointment_date = $_POST['appointment_date'];
    $appointment_time = $_POST['appointment_time'];
    $status = $_POST['status'];

    $sql = "UPDATE appointments SET
            patient_name='$patient_name',
            doctor_name='$doctor_name',
            appointment_date='$appointment_date',
            appointment_time='$appointment_time',
            status='$status'
            WHERE id=$id";
    $conn->query($sql);
    $message = "ุชู ุชุญุฏูุซ ุงูููุนุฏ ุจูุฌุงุญ!";
}

// ุญุฐู ููุนุฏ
if (isset($_GET['delete'])) {
    $id = $_GET['delete'];
    $conn->query("DELETE FROM appointments WHERE id=$id");
    $message = "ุชู ุญุฐู ุงูููุนุฏ ุจูุฌุงุญ!";
}

// ุฌูุจ ุฌููุน ุงูููุงุนูุฏ
$appointments = $conn->query("SELECT * FROM appointments ORDER BY appointment_date DESC, appointment_time DESC");

// ุฌูุจ ููุนุฏ ููุชุนุฏูู
$edit_appointment = null;
if (isset($_GET['edit'])) {
    $edit_id = $_GET['edit'];
    $edit_result = $conn->query("SELECT * FROM appointments WHERE id=$edit_id");
    if ($edit_result->num_rows > 0) {
        $edit_appointment = $edit_result->fetch_assoc();
    }
}

// ูุงุฆูุฉ ุงูุฃุทุจุงุก
$doctors = ["ุฏ. ุฃุญูุฏ", "ุฏ. ูุญูุฏ", "ุฏ. ุนูู", "ุฏ. ูุงุทูุฉ", "ุฏ. ุฎุงูุฏ"];
?>

<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ููุงุนูุฏ ุงูุฃุทุจุงุก</title>
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <style>
        body { background: #f8f9fa; padding: 20px; }
        .container { max-width: 1200px; }
        .appointment-card { background: white; padding: 20px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .status-confirmed { border-right: 4px solid #28a745; }
        .status-pending { border-right: 4px solid #ffc107; }
        .status-cancelled { border-right: 4px solid #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>๐ ุฅุฏุงุฑุฉ ููุงุนูุฏ ุงูุฃุทุจุงุก</h1>
            <div>
                <a href="dashboard.php" class="btn btn-success">๐ ุงูุฑุฆูุณูุฉ</a>
                <a href="logout.php" class="btn btn-danger">๐ช ุชุณุฌูู ุงูุฎุฑูุฌ</a>
            </div>
        </div>

        <!-- ุนุฑุถ ุงูุฑุณุงุฆู -->
        <?php if (isset($message)): ?>
            <div class="alert alert-success"><?php echo $message; ?></div>
        <?php endif; ?>

        <!-- ูููุฐุฌ ุฅุถุงูุฉ/ุชุนุฏูู ููุนุฏ -->
        <div class="appointment-card">
            <h3><?php echo $edit_appointment ? 'โ๏ธ ุชุนุฏูู ุงูููุนุฏ' : 'โ ุฅุถุงูุฉ ููุนุฏ ุฌุฏูุฏ'; ?></h3>
            <form method="post">
                <?php if ($edit_appointment): ?>
                    <input type="hidden" name="appointment_id" value="<?php echo $edit_appointment['id']; ?>">
                <?php endif; ?>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ุงุณู ุงููุฑูุถ</label>
                            <input type="text" class="form-control" name="patient_name"
                                   value="<?php echo $edit_appointment ? $edit_appointment['patient_name'] : ''; ?>" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ุงุณู ุงูุทุจูุจ</label>
                            <select class="form-select" name="doctor_name" required>
                                <option value="">ุงุฎุชุฑ ุงูุทุจูุจ</option>
                                <?php foreach($doctors as $doctor): ?>
                                    <option value="<?php echo $doctor; ?>"
                                        <?php echo ($edit_appointment && $edit_appointment['doctor_name'] == $doctor) ? 'selected' : ''; ?>>
                                        <?php echo $doctor; ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">ุชุงุฑูุฎ ุงูููุนุฏ</label>
                            <input type="date" class="form-control" name="appointment_date"
                                   value="<?php echo $edit_appointment ? $edit_appointment['appointment_date'] : ''; ?>" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">ููุช ุงูููุนุฏ</label>
                            <input type="time" class="form-control" name="appointment_time"
                                   value="<?php echo $edit_appointment ? $edit_appointment['appointment_time'] : ''; ?>" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">ุงูุญุงูุฉ</label>
                            <select class="form-select" name="status" required>
                                <option value="ูุคูุฏ" <?php echo ($edit_appointment && $edit_appointment['status'] == 'ูุคูุฏ') ? 'selected' : ''; ?>>ูุคูุฏ</option>
                                <option value="ูู ุงูุงูุชุธุงุฑ" <?php echo ($edit_appointment && $edit_appointment['status'] == 'ูู ุงูุงูุชุธุงุฑ') ? 'selected' : ''; ?>>ูู ุงูุงูุชุธุงุฑ</option>
                                <option value="ููุบู" <?php echo ($edit_appointment && $edit_appointment['status'] == 'ููุบู') ? 'selected' : ''; ?>>ููุบู</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button type="submit" name="<?php echo $edit_appointment ? 'update_appointment' : 'add_appointment'; ?>"
                        class="btn btn-primary">
                    <?php echo $edit_appointment ? 'ุชุญุฏูุซ ุงูููุนุฏ' : 'ุฅุถุงูุฉ ุงูููุนุฏ'; ?>
                </button>
                <?php if ($edit_appointment): ?>
                    <a href="appointments.php" class="btn btn-secondary">ุฅูุบุงุก</a>
                <?php endif; ?>
            </form>
        </div>

        <!-- ุนุฑุถ ุงูููุงุนูุฏ ุจุงุณุชุฎุฏุงู for loop -->
        <h3 class="mt-4">๐ ูุงุฆูุฉ ุงูููุงุนูุฏ (<?php echo $appointments->num_rows; ?>)</h3>

        <?php if ($appointments->num_rows > 0): ?>
            <?php for ($i = 0; $appointment = $appointments->fetch_assoc(); $i++): ?>
                <div class="appointment-card status-<?php echo str_replace(' ', '-', strtolower($appointment['status'])); ?>">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>๐ค <?php echo $appointment['patient_name']; ?></h5>
                            <p class="mb-1">๐ฉบ ุงูุทุจูุจ: <?php echo $appointment['doctor_name']; ?></p>
                            <p class="mb-1">๐ ุงูุชุงุฑูุฎ: <?php echo $appointment['appointment_date']; ?></p>
                            <p class="mb-1">โฐ ุงูููุช: <?php echo $appointment['appointment_time']; ?></p>
                            <span class="badge bg-<?php
                                echo $appointment['status'] == 'ูุคูุฏ' ? 'success' :
                                     ($appointment['status'] == 'ูู ุงูุงูุชุธุงุฑ' ? 'warning' : 'danger');
                            ?>">
                                <?php echo $appointment['status']; ?>
                            </span>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <a href="appointments.php?edit=<?php echo $appointment['id']; ?>" class="btn btn-warning btn-sm">โ๏ธ ุชุนุฏูู</a>
                                <a href="appointments.php?delete=<?php echo $appointment['id']; ?>" class="btn btn-danger btn-sm"
                                   onclick="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ')">๐๏ธ ุญุฐู</a>
                            </div>
                        </div>
                    </div>
                </div>
            <?php endfor; ?>
        <?php else: ?>
            <div class="alert alert-info">ูุง ุชูุฌุฏ ููุงุนูุฏ ุญุงููุงู. ุฃุถู ููุนุฏ ุฌุฏูุฏ!</div>
        <?php endif; ?>
    </div>
</body>
</html>



CREATE TABLE appointments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    patient_name VARCHAR(255) NOT NULL,
    doctor_name VARCHAR(255) NOT NULL,
    appointment_date DATE NOT NULL,
    appointment_time TIME NOT NULL,
    status ENUM('ูุคูุฏ', 'ูู ุงูุงูุชุธุงุฑ', 'ููุบู') DEFAULT 'ูู ุงูุงูุชุธุงุฑ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);